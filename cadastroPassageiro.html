<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cadastro</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --primary: #0088cc; --bg: #f0f2f5; }
    body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    .card { background: #fff; width: 90%; max-width: 380px; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
    input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,136,204,0.1); }
    .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
    .btn:disabled { background: #ccc; }
  </style>
</head>
<body>

<div class="card">
  <h2 style="margin: 0 0 20px 0;">Cadastro</h2>
  
  <input id="nome" type="text" placeholder="Nome Completo">
  
  <input id="telefone" type="tel" inputmode="tel" placeholder="WhatsApp (00) 00000-0000" maxlength="15">
  
  <input id="email" type="email" placeholder="E-mail">
  
  <input id="cpf" type="text" inputmode="numeric" placeholder="CPF 000.000.000-00" maxlength="14">
  
  <input id="senha" type="password" placeholder="Senha">
  
  <button id="btnEnviar" class="btn" onclick="enviar()">CONCLUIR</button>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  // Máscara de CPF
  document.getElementById('cpf').addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    if (v.length > 11) v = v.slice(0, 11);
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    e.target.value = v;
  });

  // Máscara de Telefone
  document.getElementById('telefone').addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    if (v.length > 11) v = v.slice(0, 11);
    v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
    v = v.replace(/(\d{5})(\d)/, '$1-$2');
    e.target.value = v;
  });

  // Validação Matemática de CPF
  function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma = 0, resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;
    return true;
  }

  function enviar() {
    const btn = document.getElementById('btnEnviar');
    const webhookUrl = "https://primary-production-a103.up.railway.app/webhook/0421cb4e-c94e-40bc-ad39-823394a4d901";

    const nome = document.getElementById('nome').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const email = document.getElementById('email').value.trim();
    const cpf = document.getElementById('cpf').value.trim();
    const senha = document.getElementById('senha').value.trim();

    if (nome === "" || senha === "" || telefone.length < 10) {
      alert("Por favor, preencha Nome, WhatsApp e Senha corretamente.");
      return;
    }

    if (cpf !== "" && !validarCPF(cpf)) {
      alert("O CPF digitado é inválido. Por favor, verifique.");
      return;
    }

    // Alteração solicitada: Texto modificado para "CADASTRADO! ✅"
    btn.disabled = true;
    btn.innerText = "CADASTRADO! ✅";

    const dados = {
      fluxo: "CADASTRO_PASSAGEIRO",
      chatId: new URLSearchParams(window.location.search).get('chatId') || tg?.initDataUnsafe?.user?.id || "WEB",
      nome, telefone, email, cpf, senha
    };

    const query = new URLSearchParams(dados).toString();
    const img = new Image();
    img.src = `${webhookUrl}?${query}&t=${Date.now()}`;

    setTimeout(() => {
      if (tg && tg.showAlert) {
        tg.showAlert("✅ Cadastro realizado!", () => tg.close());
      } else {
        alert("✅ Cadastro realizado!");
        window.location.href = "https://t.me/SEU_BOT_NOME"; 
      }
    }, 600);
  }
</script>
</body>
</html>
