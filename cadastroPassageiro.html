<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cadastro</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
    .card { background: #fff; width: 90%; max-width: 380px; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
    input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    .btn { width: 100%; padding: 16px; background: #0088cc; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
    #iframe-oculto { display: none; }
  </style>
</head>
<body>

<div class="card">
  <h2>Cadastro</h2>
  <input id="nome" type="text" placeholder="Nome Completo">
  <input id="telefone" type="tel" placeholder="WhatsApp">
  <input id="email" type="email" placeholder="E-mail">
  <input id="cpf" type="text" placeholder="CPF">
  <input id="senha" type="password" placeholder="Senha">
  <button id="btnEnviar" class="btn" onclick="enviar()">CONCLUIR</button>
</div>

<iframe name="janela-invisivel" id="iframe-oculto"></iframe>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  function enviar() {
    const btn = document.getElementById('btnEnviar');
    const webhookUrl = "https://primary-production-a103.up.railway.app/webhook/0421cb4e-c94e-40bc-ad39-823394a4d901";

    const dados = {
      fluxo: "CADASTRO_PASSAGEIRO",
      chatId: new URLSearchParams(window.location.search).get('chatId') || tg?.initDataUnsafe?.user?.id || "USER_CHROME",
      nome: document.getElementById('nome').value,
      telefone: document.getElementById('telefone').value,
      email: document.getElementById('email').value,
      cpf: document.getElementById('cpf').value,
      senha: document.getElementById('senha').value
    };

    if (!dados.nome || !dados.senha) {
      alert("Preencha nome e senha.");
      return;
    }

    // Muda o botão para dar feedback
    btn.disabled = true;
    btn.innerText = "PRONTO!";

    // Monta a URL e "atira" para o iframe invisível
    const query = new URLSearchParams(dados).toString();
    window.open(`${webhookUrl}?${query}`, 'janela-invisivel');

    // Mostra o alerta e fecha o app imediatamente
    setTimeout(() => {
      if (tg && tg.showAlert) {
        tg.showAlert("✅ Cadastro realizado!", () => {
          tg.close();
        });
      } else {
        alert("✅ Cadastro realizado com sucesso!");
        btn.innerText = "CONCLUÍDO";
      }
    }, 500); // Meio segundo é o suficiente para o disparo
  }
</script>
</body>
</html>