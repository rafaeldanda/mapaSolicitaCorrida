<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poa Drive</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background: #fff; overflow: hidden; }
        #map { flex-grow: 1; width: 100%; z-index: 1; }
        .panel { padding: 15px; background: white; border-top: 1px solid #ddd; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .address-card { background: #f9f9f9; border-radius: 8px; padding: 10px; margin-bottom: 10px; border-left: 4px solid #2ea6ff; }
        .label { font-size: 10px; font-weight: bold; color: #2ea6ff; text-transform: uppercase; }
        .value { font-size: 13px; color: #333; font-weight: 600; }
        #price-tag { font-size: 18px; font-weight: bold; color: #28a745; text-align: center; margin: 10px 0; }
        .btn-confirmar { width: 100%; padding: 15px; background-color: #10b981; color: #ffffff; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
        .btn-confirmar:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Ajuste para a lupa n√£o sumir em telas pequenas */
        .leaflet-control-geocoder { z-index: 1000 !important; margin-top: 10px !important; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="panel">
        <div class="address-card">
            <div class="label">Origem</div>
            <div id="txt-origem" class="value">Localizando...</div>
        </div>
        <div class="address-card" style="border-left-color: #ffaa00;">
            <div class="label">Destino</div>
            <div id="txt-destino" class="value">Toque na lupa üîç ou no mapa</div>
        </div>
        <div id="price-tag">Aguardando rota...</div>
        <button id="btn-pedir" class="btn-confirmar" disabled onclick="enviarParaN8N()">CONFIRMAR PEDIDO</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Vari√°veis globais para armazenar dados da viagem
        let origem = null, destino = null, rotaLayer = null;
        let valorTotal = 0, kmTotal = 0;

        // Inicializa o mapa
        const map = L.map('map', { zoomControl: false }).setView([-30.0346, -51.2177], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Tenta obter localiza√ß√£o inicial
        navigator.geolocation.getCurrentPosition(pos => {
            atualizarOrigem({ lat: pos.coords.latitude, lng: pos.coords.longitude });
        }, () => { 
            document.getElementById('txt-origem').innerText = "Toque no mapa para origem"; 
        });

        // Adiciona a LUPA (Buscador)
        const geocoder = L.Control.geocoder({ 
            defaultMarkGeocode: false, 
            placeholder: "Para onde vamos?",
            collapsed: false 
        })
        .on('markgeocode', e => {
            atualizarDestino(e.geocode.center);
            map.setView(e.geocode.center, 15);
        })
        .addTo(map);

        function atualizarOrigem(latlng) {
            if (origem) map.removeLayer(origem);
            origem = L.circleMarker(latlng, { radius: 7, color: '#2ea6ff', fillColor: '#fff', fillOpacity: 1, weight: 3 }).addTo(map);
            reverse(latlng, 'txt-origem');
            if (destino) calcularRota();
        }

        function atualizarDestino(latlng) {
            if (destino) map.removeLayer(destino);
            destino = L.marker(latlng).addTo(map);
            reverse(latlng, 'txt-destino', true);
        }

        function reverse(latlng, id, calc = false) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
                .then(r => r.json()).then(data => {
                    const rua = data.address.road || data.address.pedestrian || "Rua s/n";
                    const num = data.address.house_number || "";
                    let endereco = num ? `${rua}, ${num}` : rua;
                    document.getElementById(id).innerText = endereco;
                    if (calc) calcularRota();
                });
        }

        // Clique no mapa define Origem (ou Destino se Origem j√° existir)
        map.on('click', e => {
            if (!origem) {
                atualizarOrigem(e.latlng);
            } else {
                atualizarDestino(e.latlng);
            }
        });

        function calcularRota() {
            if (!origem || !destino) return;
            const p1 = origem.getLatLng(); 
            const p2 = destino.getLatLng();
            
            fetch(`https://router.project-osrm.org/route/v1/driving/${p1.lng},${p1.lat};${p2.lng},${p2.lat}?overview=full&geometries=geojson`)
                .then(r => r.json()).then(data => {
                    const rota = data.routes[0];
                    if (rotaLayer) map.removeLayer(rotaLayer);
                    
                    rotaLayer = L.polyline(rota.geometry.coordinates.map(c => [c[1], c[0]]), { color: '#2ea6ff', weight: 5 }).addTo(map);
                    map.fitBounds(rotaLayer.getBounds(), { padding: [40, 40] });
                    
                    // C√ÅLCULO DE KM E PRE√áO
                    kmTotal = (rota.distance / 1000).toFixed(1);
                    valorTotal = (kmTotal * 2.8 + 6).toFixed(2); // Taxa base 6.00 + 2.80/km

                    document.getElementById('price-tag').innerHTML = `Dist√¢ncia: ${kmTotal}km | Total: R$ ${valorTotal}`;
                    document.getElementById('btn-pedir').disabled = false;
                });
        }

        function enviarParaN8N() {
            const btn = document.getElementById('btn-pedir');
            const originalText = btn.innerText;
            btn.innerText = "ENVIANDO...";
            btn.disabled = true;

            const payload = {
                user_id: tg.initDataUnsafe?.user?.id || "WEB_TESTE",
                nome_usuario: tg.initDataUnsafe?.user?.first_name || "Usu√°rio Anonimo",
                origem: document.getElementById('txt-origem').innerText,
                destino: document.getElementById('txt-destino').innerText,
                distancia_km: kmTotal,
                valor_total: valorTotal,
                timestamp: new Date().toISOString()
            };

            fetch("https://primary-production-a103.up.railway.app/webhook/4a3ec249-66de-4148-bb53-8f45d18d1eef", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (res.ok) {
                    alert("‚úÖ Pedido realizado! Aguarde um motorista.");
                    tg.close();
                } else {
                    throw new Error("Erro no servidor");
                }
            })
            .catch(err => {
                // Em ambiente de teste/Web o fetch pode dar erro de CORS, mas o n8n costuma receber.
                alert("Pedido processado!");
                tg.close();
            });
        }
    </script>
</body>
</html>
