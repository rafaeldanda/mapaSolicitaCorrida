<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poa Drive - Passageiro</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background: #f8f9fa; overflow: hidden; }
        #map { flex-grow: 1; width: 100%; z-index: 1; }
        
        .panel { padding: 20px; background: white; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); border-radius: 25px 25px 0 0; z-index: 100; position: relative; }
        
        .address-card { background: #f1f5f9; border-radius: 12px; padding: 12px; margin-bottom: 15px; border-left: 5px solid #4338ca; }
        .label { font-size: 0.65rem; font-weight: 800; color: #4338ca; text-transform: uppercase; margin-bottom: 4px; }
        .value { font-size: 0.9rem; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #price-tag { font-size: 1.1rem; font-weight: 700; color: #059669; text-align: center; margin: 10px 0; }
        
        button { width: 100%; padding: 18px; border: none; border-radius: 15px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.3s; background: #10b981; color: white; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        button:disabled { background: #94a3b8; box-shadow: none; cursor: not-allowed; }
        button:active { transform: scale(0.98); }

        /* Ajuste da Lupa para Mobile */
        .leaflet-control-geocoder { border: 2px solid #4338ca !important; border-radius: 10px !important; overflow: hidden; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="panel">
        <div class="address-card">
            <div class="label">Origem (Sua posi√ß√£o)</div>
            <div id="txt-origem" class="value">Localizando GPS...</div>
        </div>
        
        <div class="address-card" style="border-left-color: #f59e0b;">
            <div class="label">Destino (Busque na lupa üîç)</div>
            <div id="txt-destino" class="value">Aguardando endere√ßo...</div>
        </div>

        <div id="price-tag">---</div>
        
        <button id="btn-pedir" disabled onclick="enviarParaN8N()">SOLICITAR MOTORISTA</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <script>
        // 1. Inicializa o Telegram e garante o expand
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const map = L.map('map', { zoomControl: false }).setView([-30.0346, -51.2177], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let origem = null, destino = null, rotaLayer = null;

        // 2. Localiza√ß√£o Inicial
        navigator.geolocation.getCurrentPosition(pos => {
            const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            atualizarOrigem(latlng);
        }, () => {
            document.getElementById('txt-origem').innerText = "Clique no mapa para marcar origem";
        });

        // 3. Busca de Endere√ßo
        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Para onde voc√™ vai?",
        }).on('markgeocode', function(e) {
            atualizarDestino(e.geocode.center);
        }).addTo(map);

        function atualizarOrigem(latlng) {
            if (origem) map.removeLayer(origem);
            origem = L.circleMarker(latlng, { radius: 8, color: '#4338ca', fillColor: '#fff', fillOpacity: 1, weight: 3 }).addTo(map);
            map.setView(latlng, 15);
            reverseGeocode(latlng, 'txt-origem');
        }

        function atualizarDestino(latlng) {
            if (destino) map.removeLayer(destino);
            destino = L.marker(latlng).addTo(map);
            reverseGeocode(latlng, 'txt-destino', true);
        }

        function reverseGeocode(latlng, elementId, calcRoute = false) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
                .then(r => r.json()).then(data => {
                    const rua = data.address.road || data.address.pedestrian || "Endere√ßo desconhecido";
                    const num = data.address.house_number || "";
                    document.getElementById(elementId).innerText = num ? `${rua}, ${num}` : rua;
                    if (calcRoute) calcularRota();
                });
        }

        map.on('click', e => atualizarOrigem(e.latlng));

        function calcularRota() {
            if (!origem || !destino) return;
            const p1 = origem.getLatLng();
            const p2 = destino.getLatLng();
            
            fetch(`https://router.project-osrm.org/route/v1/driving/${p1.lng},${p1.lat};${p2.lng},${p2.lat}?overview=full&geometries=geojson`)
                .then(r => r.json()).then(data => {
                    const rota = data.routes[0];
                    const coords = rota.geometry.coordinates.map(c => [c[1], c[0]]);
                    if (rotaLayer) map.removeLayer(rotaLayer);
                    rotaLayer = L.polyline(coords, { color: '#4338ca', weight: 6, opacity: 0.8 }).addTo(map);
                    map.fitBounds(rotaLayer.getBounds(), { padding: [40, 40] });

                    const km = (rota.distance / 1000).toFixed(1);
                    const preco = (km * 2.8 + 6).toFixed(2); // Exemplo: R$ 6 base + 2.80 por km
                    document.getElementById('price-tag').innerHTML = `Dist√¢ncia: ${km} km ‚Ä¢ <b>R$ ${preco}</b>`;
                    document.getElementById('btn-pedir').disabled = false;
                });
        }

        async function enviarParaN8N() {
            const btn = document.getElementById('btn-pedir');
            btn.disabled = true;
            btn.innerText = "CONTATANDO MOTORISTAS...";

            // Captura segura de ID do Telegram
            const userId = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user.id : "USER_WEB";

            const payload = {
                user_id: userId,
                origem: document.getElementById('txt-origem').innerText,
                destino: document.getElementById('txt-destino').innerText,
                lat_orig: origem.getLatLng().lat,
                lon_orig: origem.getLatLng().lng,
                lat_dest: destino.getLatLng().lat,
                lon_dest: destino.getLatLng().lng,
                valor: document.getElementById('price-tag').innerText
            };

            try {
                const res = await fetch('https://primary-production-a103.up.railway.app/webhook/4a3ec249-66de-4148-bb53-8f45d18d1eef', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    // Verifica√ß√£o de ambiente para Alerta
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("‚úÖ Solicita√ß√£o enviada! Aguarde o contato de um motorista no chat.", () => {
                            tg.close(); // Fecha o WebApp
                        });
                    } else {
                        alert("‚úÖ Sucesso! O n8n recebeu seu pedido.");
                        location.reload();
                    }
                } else {
                    throw new Error();
                }
            } catch (e) {
                const msg = "Erro ao enviar. Verifique sua internet.";
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) tg.showAlert(msg); else alert(msg);
                btn.disabled = false;
                btn.innerText = "SOLICITAR MOTORISTA";
            }
        }
    </script>
</body>
</html>